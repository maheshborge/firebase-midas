<!DOCTYPE html>
<html lang="en">
<head>
<body>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MSP Mandi Dashboard</title>
<style>
  /* ===== HIDE BLOGGER MAIN HEADER ===== */
  header, #header, .Header, #Header1, #Blog1 header { display: none !important; }

  /* Remove top white gap */
  body { padding-top: 0 !important; margin-top: 0 !important; font-family: 'Poppins', sans-serif; }

  /* ========================= GRID LAYOUT ========================= */
  .cards-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-top: 16px;
    grid-auto-rows: auto;
  }
  #completed.cards-grid { align-items: stretch; }
  #market.cards-grid { display: block; }

  @media(max-width: 1100px) { .cards-grid { grid-template-columns: repeat(2, 1fr); } }
  @media(max-width: 780px) { .cards-grid { grid-template-columns: 1fr; } }

  /* ========================= CROP CARD ========================= */
  .crop-card {
    background: white;
    border-radius: 14px;
    border: 1px solid #e5e7eb;
    padding: 12px;
    height: auto;
    position: relative;
  }
  .crop-card-inner {
    display: flex;
    gap: 14px;
    align-items: flex-start;
  }
  .crop-left { flex: 1; }
  .crop-photo {
    width: 100px;
    max-height: 100px;
    border-radius: 10px;
    object-fit: cover;
    flex-shrink: 0;
  }

  /* ========================= GLOBAL ========================= */
  body {
    font-family: Inter, Arial, sans-serif;
    background: #f3f6fb;
    margin: 0;
    color: #111;
  }
  .container {
    max-width: 1100px;
    margin: 18px auto;
    padding: 8px 16px;
  }

  /* ========================= HEADER ========================= */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #2E6F40;
    padding: 18px;
    border-radius: 10px;
    color: white;
    margin-bottom: 16px;
  }
  .brand { display: flex; gap: 12px; align-items: center; }
  .brand h1 { margin: 0; font-size: 24px; }
  .meta { text-align: right; font-size: 14px; }
  #logoutBtn {
    background: #ef4444;
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    margin-top: 8px;
  }

  /* ========================= TABS ========================= */
  .tabs { display: flex; gap: 8px; margin: 2px 0; overflow-x: auto; }
  .tab {
    padding: 6px 12px;
    border-radius: 9px;
    background: white;
    border: 1px solid #e5e7eb;
    color: #2563eb;
    cursor: pointer;
    font-weight: 500;
    font-size: 14px;
    margin: 4px 0;
    white-space: nowrap;
  }
  .tab.active { background: #2563eb; color: white; }
  
  /* ========================= HOME / DASHBOARD STYLES (UPDATED) ========================= */
  .home-wrap{ margin-top:12px; }

  /* UPDATED KPI GRID: 2 Columns on Mobile */
  .kpi-grid{
    display:grid;
    grid-template-columns: repeat(2, 1fr); /* FORCED 2 COLUMNS */
    gap: 12px;
    margin-bottom: 20px;
  }
  @media(min-width:768px){
    .kpi-grid{ grid-template-columns:repeat(4,1fr); }
  }
  .kpi-card{
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:14px;
    padding:16px 10px;
    text-align: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
  }
  .kpi-title{
    font-size:12px;
    color:#6b7280;
    margin-bottom:6px;
    font-weight: 600;
    text-transform: uppercase;
  }
  .kpi-value{
    font-size:22px;
    font-weight:800;
    color: #2563eb;
  }

  /* UPDATED CROP SUMMARY LIST */
  .crop-list{
    display:flex;
    flex-direction:column;
    gap:12px;
    margin-top:10px;
  }
  .summary-card {
    background: white;
    border-radius: 12px;
    padding: 14px;
    border: 1px solid #f0f0f0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .sum-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px dashed #e5e7eb;
    padding-bottom: 8px;
  }
  .sum-name { font-size: 16px; font-weight: 700; color: #111; }
  .sum-badge { 
    background: #e0f2fe; color: #0284c7; 
    font-size: 12px; font-weight: 700; 
    padding: 4px 10px; border-radius: 20px; 
  }
  .sum-stats {
    display: flex;
    justify-content: space-between;
    background: #f9fafb;
    padding: 8px 12px;
    border-radius: 8px;
  }
  .stat-box { display: flex; flex-direction: column; align-items: center; }
  .stat-lbl { font-size: 10px; color: #6b7280; font-weight: 600; text-transform: uppercase; }
  .stat-val { font-size: 14px; font-weight: 700; color: #374151; margin-top: 2px; }
  .stat-month { font-size: 9px; color: #9ca3af; font-weight: 500; text-transform: uppercase; }
  
  /* Crop summary ‚Äì 2 column layout */
.crop-summary-grid{
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
}

/* Each crop card */
.crop-card-summary{
  background: #fff;
  border-radius: 14px;
  padding: 16px;
  border: 1px solid #eee;
}

/* Mobile fix */
@media (max-width: 768px){
  .crop-summary-grid{
    grid-template-columns: 1fr;
  }
}

  
  /* ========================= FORMS ========================= */
  .card {
    background: white;
    padding: 18px;
    border-radius: 14px;
    margin-bottom: 20px;
    box-shadow: 0 6px 18px rgba(0,0,0,.05);
    border: 1px solid #f2f5fb;
  }
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  @media(max-width:800px) { .grid { grid-template-columns: 1fr; } }
  
  label { font-weight: 600; margin-top: 10px; display: block; font-size: .9rem; color: #374151; }
  input, select {
    width: 100%; padding: 10px; margin-top: 6px;
    border-radius: 8px; border: 1px solid #dbe6f1; background: #fbfdff; font-size: .95rem;
    box-sizing: border-box;
  }
  .btn {
    background: #2563eb; color: white; width: 100%; padding: 12px;
    border: none;
    border-radius: 10px; font-weight: 700; margin-top: 14px; cursor: pointer;
  }
  .btn.secondary { background: #06b6d4; width: auto; }

  /* ========================= MINI INFO ========================= */
  .line { margin: 4px 0; font-size: .9rem; }
  .net-pill {
    background: #2563eb; color: white;
    padding: 4px 10px;
    font-size: .8rem; border-radius: 6px; display: inline-block; margin-top: 4px;
  }
  .paid-badge {
    background: #16a34a; color: white;
    padding: 1px 5px;
    border-radius: 6px; font-size: .75rem; display: inline-block; margin-bottom: 4px;
  }

  /* ========================= BUYER MINI FORM ========================= */
  .buyer-mini {
    background: #f9fafb; border-left: 3px solid #2563eb;
    padding: 12px; margin-top: 10px;
    border-radius: 8px;
  }

  /* ========================= FLOATING BUTTONS ========================= */
  .fab-add, .fab-wa {
    position: fixed; bottom: 80px; width: 56px; height: 56px;
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    color: white; box-shadow: 0 6px 18px rgba(0,0,0,.2); cursor: pointer; z-index: 99;
  }
  .fab-add { right: 20px; background: #2563eb; font-size: 32px; }
  .fab-wa { left: 20px; background: #25D366; font-size: 28px; }

  /* ================= COMPLETED CARD SPECIFIC ================= */
  .action-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    flex-wrap: nowrap;
  }
  #completed .crop-left .net-pill {
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 36px;
    border-radius: 8px;
    font-weight: 700;
    background: #2563eb;
    box-shadow: 0 4px 10px rgba(0,0,0,.2);
    position: relative;
    padding: 0 12px 0 60px; /* Space for PAID badge */
    font-size: 13px;
    margin: 0;
  }
  #completed .crop-left .net-pill::before {
    content: "PAID";
    position: absolute;
    left: 6px;
    top: 50%;
    transform: translateY(-50%);
    background: #16a34a;
    color: #fff;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 800;
  }
  
  #completed .crop-left > .paid-badge { display: none; }
  .crop-left .btn.secondary {
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 36px;
    border-radius: 8px;
    font-weight: 700;
    background: #06b6d4;
    padding: 0 16px;
    font-size: 13px;
    box-shadow: 0 4px 10px rgba(0,0,0,.2);
    margin: 0;
  }
  
  
  
.modal-backdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.modal-box{
  background:#fff;
  width:90%;
  max-width:360px;
  padding:24px;              /* merged */
  border-radius:12px;
  max-height:85vh;           /* signup safe */
  overflow-y:auto;
}

.modal-box h3{
  margin-bottom:8px;
}

.modal-box p{
  margin-bottom:16px;
  font-size:14px;
  color:#555;
}

.modal-box input{
  width:100%;
  margin:8px 0;
  padding:10px;
}

.modal-actions{
  display:flex;
  gap:12px;
  margin-top:14px;
  justify-content:flex-end;
}

  
  /* ================= Market ================= */
  .market-pill{
    height:34px;
    padding:0 12px;
    border-radius:9px;
    background:#f1f5f9;
    border:1px solid #ddd;
    font-size:13px;
    font-weight:600;
    display:flex;
    align-items:center;
    gap:6px;
  }
  #market iframe{
    width:100%;
    height:250vh;
    border:none;
    border-radius:14px;
    background:#fff;
  }
  #market .crop-card{ padding:0; border:none; background:transparent; }
  .market-bar{
    display:flex;
    gap:6px;
    align-items:center;
    background:#fff;
    padding:6px 8px;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,.08);
    margin-top:2px;
    flex-wrap:wrap;
  }
  .market-pill select{
    height:32px;
    line-height:32px;
    padding:0 12px;
    font-size:13px;
    border:none;
    background:transparent;
    font:inherit;
    cursor:pointer;
    align-items:center;
  }
  .market-item{ display:flex; align-items:center; gap:6px; }
  .market-item input{ padding:6px 10px; border-radius:8px; border:1px solid #ddd; }
  #marketDate{ position:absolute; opacity:0; pointer-events:none; }
  #dateLabel{
    padding:6px 10px;
    border-radius:9px;
    background:#f1f5f9;
    font-weight:600;
    cursor:pointer;
    font-size:13px;
    height:20px;
    display:flex;
    align-items:center;
  }
  
  
  /* default ‚Äì dashboard (tabs ‡§ö‡•ç‡§Ø‡§æ ‡§ñ‡§æ‡§≤‡•Ä) */
#globalTicker{
  position: sticky;
  top: 0;
  z-index: 100;
}
  
  .login-mode #globalTicker{
  top: 12px;
  max-width: 600px;
  margin: 0 auto 16px auto;
}

  body:not(.login-mode) #globalTicker{
  top: 110px;   /* üî• header + tabs height */
  margin: 8px 0 12px 0;
}
 
  /* login screen ticker spacing */
.login-mode .ticker-wrap{
  margin-top: 10px;
  margin-bottom: 30px;   /* ‚≠ê Forgot PIN ‡§∏‡§æ‡§†‡•Ä ‡§ú‡§æ‡§ó‡§æ */
}

  
.ticker-wrap{
  width: 100%;
  height: 32px;                 /* üëà input box height */
  overflow: hidden;

  background: #eaf2ff;          /* üëà input field background */
  border: 1px solid #dbeafe;    /* üëà soft border */
  border-radius: 12px;          /* üëà same rounded as input */

  display: flex;
  align-items: center;
  padding: 8 8px;              /* üëà input-like padding */
  box-sizing: border-box;
}

.ticker{
  display: flex;
  align-items: center;
  white-space: nowrap;
  font-size: 18px;              /* üëà input text size */
  font-weight: 500;
  color: #2563eb;

  animation: scrollRTL 40s linear infinite;
}


/* pause via JS (mobile tap / close btn) */
.ticker.paused{
  animation-play-state: paused;
}

/* each content block */
.ticker-content{
  display:flex;
  align-items:center;
  gap:40px;
}

/* links */
.ticker a{
  color: #2563eb;
  text-decoration: none;
  white-space: nowrap;
}


/* separator */
.sep{
  margin: 0 14px;
  color: #9ca3af;
}


@keyframes scrollRTL{
  0%   { transform: translateX(100%); }
  100% { transform: translateX(-50%); }
}


/* mobile speed */
@media (max-width: 768px){
  .ticker{
    animation-duration: 25s;
  }
}

</style>

<div class="ticker-wrap" id="globalTicker" style="display:none;">
  <div class="ticker" id="ticker"></div>
</div>

<div id="loginScreen" style="margin: 40px auto; max-width: 400px; padding: 20px;">
  <div style="text-align: center; margin-bottom: 20px;">
    <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiLGMqNKeTtp2zcz08QL5acnXbUt6bIFwtavORjtzNxlJpoD2dVVjL3WSGPhJhJ7_cAQbgHKwK7nUobNwjx6-AGmONjgweNRInJSmyQYtOcL8vIFKrBWNuPDaAlfDai7CG3mXU0xlPdOCHLniCoHviwTb4G7XKgCAIlchqn4Nv-nR5WzpjABl93CXjxb00/w232-h216/MSP_Mazisheti_Transparant_%20Logo_Dark_HQ.png" width="120" />
  </div>

  <h2 style="color:#1d4ed8; margin-bottom:10px; text-align:center;">
    MSP Mandi Login
  </h2>
  
  <label>Mobile No. / Reg No.</label>
  <input id="loginUser" type="text" placeholder="Mobile ‡§ï‡§ø‡§Ç‡§µ‡§æ Registration No." />

  <label style="margin-top:12px;">6-digit PIN</label>
  <input id="loginPin" maxlength="6" type="password" />

  <button class="btn" onclick="doLogin()">Login</button>

  <div id="loginMsg" style="text-align:center; margin-top:10px; color:red;"></div>
 

  <!-- PIN Recovery Modal -->
<div id="appModal" class="modal-backdrop" style="display:none;">
  <div class="modal-box">
    <h3 id="modalTitle">Forgot PIN</h3>
    <p id="modalMsg">Mobile ‡§Ü‡§£‡§ø Registration No. ‡§ü‡§æ‡§ï‡§æ</p>

    <input id="recMobile" placeholder="Mobile No." />
    <input id="recReg" placeholder="Registration No." />

    <div class="modal-actions" style="display:flex;gap:12px;justify-content:flex-end;">
  <button class="btn secondary" onclick="closeModal()">Cancel</button>
  <button class="btn" onclick="recoverPin()">Submit</button>
</div>

  </div>
</div>
  
<div style="
  text-align:center;
  margin-top:14px;
  font-size:14px;
  color:#555;
">
  <span style="cursor:pointer;color:#2563eb;font-weight:500;" onclick="openRecoverPin()">
    Forgot PIN? ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§µ‡§ø‡§∏‡§∞‡§≤‡§æ?
  </span>
  &nbsp;|&nbsp;
  <span style="cursor:pointer;color:#2563eb;font-weight:500;" onclick="openSignup()">
    Sign Up ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä ‡§ï‡§∞‡§æ. 
  </span>
</div>


</div>


<div id="dashboard" style="display: none;">
  <div class="container">

    <div class="header">
      <div class="brand">
        <div style="background: white; border-radius: 10px; height: 50px; width: 50px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
          <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiLGMqNKeTtp2zcz08QL5acnXbUt6bIFwtavORjtzNxlJpoD2dVVjL3WSGPhJhJ7_cAQbgHKwK7nUobNwjx6-AGmONjgweNRInJSmyQYtOcL8vIFKrBWNuPDaAlfDai7CG3mXU0xlPdOCHLniCoHviwTb4G7XKgCAIlchqn4Nv-nR5WzpjABl93CXjxb00/s320/MSP_Mazisheti_Transparant_%20Logo_Dark_HQ.png" style="height: 100%; width: 100%; object-fit: contain;" />
        </div>
      </div>
      <div class="meta">
        <div>Helpline üìû 9518963675</div>
        <div id="userInfo" style="font-size: 13px; margin-top: 4px; font-weight:bold;"></div>
        <button id="logoutBtn" onclick="doLogout()">Logout</button>
      </div>
  
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="home" onclick="switchTab('home')">Home</div>
      <div class="tab" data-tab="available" onclick="switchTab('available')">Available Crops</div>
      <div class="tab" data-tab="sold" onclick="switchTab('sold')">Sold / Pending</div>
      <div class="tab" data-tab="completed" onclick="switchTab('completed')">Completed</div>
      <div class="tab" data-tab="market" onclick="switchTab('market')">Market</div>
    </div>
    
<!-- TAB CONTENTS -->
<div id="home" class="home-wrap">
  <div id="dashboardTickerSlot"></div>

  <div style="display:flex;justify-content:space-between;align-items:center;margin:10px 0;">
  <h3 style="margin:0;">Buyer Requirements</h3>
  <span style="color:#2563eb;cursor:pointer;font-weight:600"
        onclick="switchTab('requirements')">
    View All &gt;
  </span>
</div>
  

<div id="buyerReqScroll"
     style="display:flex;gap:12px;overflow-x:auto;padding-bottom:10px;">
</div>

  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-title">‡§è‡§ï‡•Ç‡§£ ‡§™‡§æ‡§µ‡§§‡•ç‡§Ø‡§æ</div>
      <div class="kpi-value" id="kpiCSN">0</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-title">‡§è‡§ï‡•Ç‡§£ ‡§™‡§ø‡§ï‡•á</div>
      <div class="kpi-value" id="kpiCrops">0</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-title">‡§è‡§ï‡•Ç‡§£ ‡§Æ‡§æ‡§≤ (Kg)</div>
      <div class="kpi-value" id="kpiQty">0</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-title">‡§è‡§ï‡•Ç‡§£ ‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ)</div>
      <div class="kpi-value" id="kpiNet">0</div>
    </div>
  </div>

  <div id="farmerSummary">
  <h3>‡§™‡§ø‡§ï‡§æ‡§Ç‡§ö‡§æ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂</h3>
  <div id="cropWise" class="crop-summary-grid"></div>
</div>
</div>

    <div class="cards-grid" id="available" style="display:none;"></div>
    <div class="cards-grid" id="sold" style="display: none;"></div>
    <div class="cards-grid" id="completed" style="display: none;"></div>
    
    <div class="cards-grid" id="market" style="display:none;">
      <div class="market-bar">
        <div class="market-item market-pill">
          üìÖ <span id="dateLabel"></span>
          <input type="date" id="marketDate">
        </div>
        <div class="market-item market-pill">
          üè¨ <select id="mandiSelect">
            <option value="mumbai" selected>Mumbai</option>
            <option value="pune">Pune</option>
            <option value="sangli">Sangli</option>
          </select>
        </div>
        <div class="market-item market-pill">
          ü•¨
          <select id="typeSelect">
            <option value="veg" selected>‡§≠‡§æ‡§ú‡•Ä‡§™‡§æ‡§≤‡§æ</option>
            <option value="fruit">‡§´‡§≥‡•á</option>
            <option value="dhanya">‡§ß‡§æ‡§®‡•ç‡§Ø‡•á</option>
            <option value="masala">‡§Æ‡§∏‡§æ‡§≤‡§æ</option>
            <option value="turbhe">‡§ï‡§æ‡§Ç‡§¶‡§æ-‡§¨‡§ü‡§æ‡§ü‡§æ</option>
          </select>
        </div>
      </div>

      <div id="marketResult" style="margin:8px 4px; font-weight:600;"></div>

      <div class="crop-card" style="padding:0;">
        <iframe id="marketFrame"></iframe>
      </div>
    </div>
        
    <div class="card" id="sellerForm" style="display: none;">
      <h2 style="color: #1d4ed8; margin-bottom: 10px; text-align: center;">Add New Crop</h2>
      <div class="grid">
        <div><label>Crop</label><input id="s_crop" type="text" placeholder="e.g. Tomato" /></div>
        <div><label>Variety</label><input id="s_variety" type="text" /></div>
      </div>
      <div class="grid">
        <div><label>Harvest Date</label><input id="s_harv" type="date" /></div>
        <div>
          <label>Packing Type</label>
          <select id="s_packType">
            <option>Bags</option><option>Goni</option>
            <option>Crate</option><option>Carton box</option>
            <option>Other</option>
          </select>
        </div>
      </div>
      <div class="grid">
        <div><label>Packing Nos</label><input id="s_packNos" type="number" /></div>
        <div><label>Weight (Kg)</label><input id="s_weight" type="number" /></div>
      </div>
      <label>Photo URL</label>
      <input id="s_photo" type="text" placeholder="https://..." />
      <button class="btn" onclick="submitSeller()">Submit Crop</button>
      <div id="sellerMsg" style="margin-top:10px; text-align:center;"></div>
    </div>

  </div> 

  <div class="fab-add" onclick="handleFabAction()">
    <i class="fa-solid fa-plus"></i>
  </div>
  <div class="fab-wa" onclick="window.open('https://wa.me/919518963675','_blank')">
    <i class="fa-brands fa-whatsapp"></i>
  </div>

</div> 

<div id="billImageBox" style="position: fixed; top: 0; left: -9999px; background: white; border: 2px solid #000; font-family: 'Noto Sans Devanagari', sans-serif; padding: 30px; width: 650px; z-index: -100;"></div>
  
  
  <div class="card" id="buyerReqForm" style="display:none;">
  <h3 style="text-align:center;color:#1d4ed8;">Add Buyer Requirement</h3>

  <div class="grid">
    <div>
      <label>Crop</label>
      <input id="br_crop" placeholder="e.g. Tomato">
    </div>
    <div>
      <label>Variety</label>
      <input id="br_variety">
    </div>
  </div>

  <div class="grid">
    <div>
      <label>Quantity (Kg)</label>
      <input id="br_qty" type="number">
    </div>
    <div>
      <label>Expected Rate</label>
      <input id="br_rate" type="number">
    </div>
  </div>

  <div class="grid">
    <div>
      <label>Location</label>
      <input id="br_location">
    </div>
    <div>
      <label>Delivery Date</label>
      <input id="br_date" type="datetime-local">
    </div>
  </div>

  <label>Frequency</label>
  <select id="br_freq">
    <option>One-time</option>
    <option>Weekly</option>
    <option>Monthly</option>
  </select>

  <button class="btn" onclick="submitBuyerRequirement()">Post Requirement</button>
  <div id="br_msg" style="text-align:center;margin-top:8px;"></div>
</div>

  <div id="csnModal" class="modal-backdrop" style="display:none;">
  <div class="modal-box" style="text-align:center;">
    <h2 style="color:#16a34a;">Crop Added Successfully ‚úÖ</h2>

    <p style="margin-top:10px;font-size:16px;">
      ‡§§‡•Å‡§Æ‡§ö‡§æ CSN ‡§®‡§Ç‡§¨‡§∞:
    </p>

    <div style="
      font-size:22px;
      font-weight:700;
      margin:12px 0;
      color:#1d4ed8;
      letter-spacing:1px;
    " id="csnValue"></div>

    <p style="font-size:13px;color:#555;">
      ‡§ï‡•É‡§™‡§Ø‡§æ ‡§π‡§æ CSN ‡§®‡§Ç‡§¨‡§∞ ‡§®‡•ã‡§ü ‡§ï‡§∞‡•Ç‡§® ‡§†‡•á‡§µ‡§æ.
    </p>

    <button class="btn" onclick="closeCSNModal()">OK</button>
  </div>
</div>
  
      <!-- ================= SIGNUP MODAL ================= -->
<div id="signupModal" class="modal-backdrop" style="display:none;">
  <div class="modal-box">

    <h3 style="text-align:center;color:#1d4ed8;">‡§®‡§µ‡•Ä‡§® ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä</h3>

    <input id="su_name" placeholder="‡§®‡§æ‡§µ ‡§≤‡§ø‡§π‡§æ">

    <input id="su_mobile" maxlength="10"
           placeholder="10 ‡§Ö‡§Ç‡§ï‡•Ä ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§ü‡§æ‡§ï‡§æ">

<select id="su_type">
  <option value="">‡§Ø‡•Å‡§ú‡§∞ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§®‡§ø‡§µ‡§°‡§æ</option>
  <option value="Farmer">Farmer / ‡§∂‡•á‡§§‡§ï‡§∞‡•Ä</option>
  <option value="Collection Center">Collection Center / ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞</option>
  <option value="Buyer">Buyer / ‡§ñ‡§∞‡•á‡§¶‡•Ä‡§¶‡§æ‡§∞</option>
  <option value="Supplier">Supplier / ‡§™‡•Å‡§∞‡§µ‡§†‡§æ‡§¶‡§æ‡§∞</option>
  <option value="Transporter">Transporter / ‡§µ‡§æ‡§π‡§§‡•Ç‡§ï‡§¶‡§æ‡§∞</option>
  <option value="Manager">Coordinator / ‡§∏‡§Æ‡§®‡•ç‡§µ‡§Ø‡§ï </option>
</select>


    <!-- AUTO location -->
    <div id="locAuto">
      <select id="su_state" onchange="onStateChange()">
        <option value="">‡§∞‡§æ‡§ú‡•ç‡§Ø ‡§®‡§ø‡§µ‡§°‡§æ</option>
      </select>

      <select id="su_district" onchange="onDistrictChange()">
        <option value="">‡§ú‡§ø‡§≤‡•ç‡§π‡§æ ‡§®‡§ø‡§µ‡§°‡§æ</option>
      </select>

      <select id="su_block">
        <option value="">‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§®‡§ø‡§µ‡§°‡§æ</option>
      </select>
    </div>

    <!-- MANUAL location -->
    <div id="locManual" style="display:none;">
      <input id="su_district_manual" placeholder="‡§ú‡§ø‡§≤‡•ç‡§π‡§æ ‡§≤‡§ø‡§π‡§æ">
      <input id="su_block_manual" placeholder="‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§≤‡§ø‡§π‡§æ">
    </div>

    <input id="su_village" placeholder="‡§ó‡§æ‡§µ‡§æ‡§ö‡•á ‡§®‡§æ‡§µ ‡§≤‡§ø‡§π‡§æ">

    <input id="su_pin" maxlength="6" type="password"
           placeholder="6 ‡§Ö‡§Ç‡§ï‡•Ä ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° / PIN ‡§≤‡§ø‡§π‡§æ">

    <div class="modal-actions">
      <button class="btn secondary" onclick="closeSignup()">Cancel</button>
      <button class="btn" onclick="submitSignup()">Register</button>
    </div>

    <div id="su_msg" style="text-align:center;margin-top:8px;"></div>

  </div>
</div>


  
      <!-- ================= SIGNUP complete ================= -->
  <div id="regSuccessModal" class="modal-backdrop" style="display:none;">
  <div class="modal-box" style="text-align:center;">
    <h3 style="color:#16a34a;">‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä ‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä ‚úÖ</h3>
    <p id="regMsg"></p>
    <div id="regNoBox"
         style="font-size:22px;font-weight:700;color:#1d4ed8;margin:10px 0;"></div>
    <button class="btn" onclick="closeRegSuccess()">OK</button>
  </div>
</div>



<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

<script>
console.log("JS STARTED");

window.onerror = function (msg, src, line) {
  console.error("JS ERROR:", msg, "line:", line);
};

const API = "https://script.google.com/macros/s/AKfycbwaZE0dgDRgOREmw5FsHibYMtM_PTK0d-YZkfGxT8W4mNVByucXlV8xZQTFpfeGoxKf/exec"; 

function $(id){ return document.getElementById(id); }
  
/* ================= SIGN UP ================= */

function openSignup(){
  document.getElementById("signupModal").style.display = "flex";
}

function closeSignup(){
  document.getElementById("signupModal").style.display = "none";
}

async function submitSignup(){

  const stateVal = su_state.value;

  // ---- derive zone safely (AUTO states only) ----
  let zoneVal = "";
  let districtVal = "";
  let blockVal = "";

  if(stateVal === "Other"){
    districtVal = su_district_manual.value.trim();
    blockVal    = su_block_manual.value.trim();
  } else {
    zoneVal     = LOC[stateVal]?.zone || "";
    districtVal = su_district.value;
    blockVal    = su_block.value;
  }

  const payload = {
    action  : "signupUser",
    name    : su_name.value.trim(),
    mobile  : su_mobile.value.trim(),
    type    : su_type.value,
  state: su_state.value,
  district: su_state.value === "Other"
              ? su_district_manual.value
              : su_district.value,
  block: su_state.value === "Other"
              ? su_block_manual.value
              : su_block.value,
    village : su_village.value.trim(),
    pin     : su_pin.value
  };

  su_msg.innerText = "Registering...";

  try{
    const r   = await fetch(API,{
      method:"POST",
      body: JSON.stringify(payload)
    });
    const res = await r.json();

    if(res.status === "EXISTS"){
      su_msg.innerText = "Mobile already registered";
      return;
    }

    if(res.status !== "SUCCESS"){
      su_msg.innerText = "Error. Try again";
      return;
    }

    closeSignup();

    regMsg.innerHTML =
      `‡§®‡§Æ‡§∏‡•ç‡§§‡•á <b>${payload.name}</b>,<br>
       ‡§§‡•Å‡§Æ‡§ö‡•Ä <b>${payload.type}</b> ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä ‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä ‡§ù‡§æ‡§≤‡•Ä ‡§Ü‡§π‡•á.<br>
       ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï :`;

    regNoBox.innerText = res.reg;
    regSuccessModal.style.display = "flex";

  }catch(e){
    console.error(e);
    su_msg.innerText = "Network error. Try again";
  }
}

function closeRegSuccess(){
  regSuccessModal.style.display = "none";
}

/* ================= LOCATION ================= */

let LOC = {};

async function loadLocations(){
  console.log("loadLocations called");

  const res = await fetch(API + "?action=getLocations");
  LOC = await res.json();

  const states = Object.keys(LOC);

  su_state.innerHTML =
    `<option value="">‡§∞‡§æ‡§ú‡•ç‡§Ø ‡§®‡§ø‡§µ‡§°‡§æ</option>` +
    states.map(s => `<option value="${s}">${s}</option>`).join("") +
    `<option value="Other">Other</option>`;
}


function onStateChange(){
  const state = su_state.value;

  // --- RESET UI FIRST ---
  document.getElementById("locAuto").style.display = "block";
  document.getElementById("locManual").style.display = "none";

  su_district.innerHTML = `<option value="">‡§ú‡§ø‡§≤‡•ç‡§π‡§æ ‡§®‡§ø‡§µ‡§°‡§æ</option>`;
  su_block.innerHTML    = `<option value="">‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§®‡§ø‡§µ‡§°‡§æ</option>`;

  // --- OTHER STATE ---
  if(state === "Other"){
    document.getElementById("locAuto").style.display = "none";
    document.getElementById("locManual").style.display = "block";
    return;
  }

  // --- NORMAL STATE (eg. Maharashtra) ---
  if(!LOC[state]) return;

  const districts = Object.keys(LOC[state].districts);

  su_district.innerHTML =
    `<option value="">‡§ú‡§ø‡§≤‡•ç‡§π‡§æ ‡§®‡§ø‡§µ‡§°‡§æ</option>` +
    districts.map(d => `<option value="${d}">${d}</option>`).join("");
}


function onDistrictChange(){
  const state = su_state.value;
  const district = su_district.value;

  if(!state || !district || !LOC[state]) return;

  const blocks = Object.keys(LOC[state].districts[district].blocks);

  su_block.innerHTML =
    `<option value="">‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§®‡§ø‡§µ‡§°‡§æ</option>` +
    blocks.map(b => `<option value="${b}">${b}</option>`).join("");
}


document.addEventListener("DOMContentLoaded", loadLocations);

/* ================= LOGIN ================= */
async function doLogin(){
  $("loginMsg").innerText = "Checking...";
  const id = $("loginUser").value.trim();
  const pin = $("loginPin").value.trim();
  try {
    const r = await fetch(API, {
      method: "POST",
      body: JSON.stringify({ action: "loginUser", id, pin })
    });
    const t = await r.text();
    if(t === "INVALID"){ $("loginMsg").innerText = "Wrong login details"; return; }
    const user = JSON.parse(t);
    localStorage.setItem("mspUser", JSON.stringify(user));
    openDashboard(user);
  } catch(e) {
    $("loginMsg").innerText = "Connection Error";
    console.error(e);
  }
}

window.onload = () => {

  // default: login screen
  document.body.classList.add("login-mode");

  // load ticker content ONCE
  loadTicker();

  // place ticker below Forgot PIN (login screen)
  const slot = document.getElementById("loginTickerSlot");
  const ticker = document.getElementById("globalTicker");
  if(slot && ticker){
    slot.appendChild(ticker);
    ticker.style.display = "block";
  }

  // auto-login check
  const u = localStorage.getItem("mspUser");
  if(u){
    openDashboard(JSON.parse(u));
  }
};



function doLogout(){
  localStorage.removeItem("mspUser");
  location.reload();
}

function loadAllTabs(){
  loadAvailable();
  loadSold();
  loadCompleted();
}
  
  function openRecoverPin(){
  $("appModal").style.display = "flex";
  $("modalMsg").innerText = "Mobile ‡§Ü‡§£‡§ø Registration No. ‡§ü‡§æ‡§ï‡§æ";
}

function closeModal(){
  $("appModal").style.display = "none";
}

async function recoverPin(){
  const mobile = $("recMobile").value.trim();
  const reg    = $("recReg").value.trim();

  if(!mobile || !reg){
    $("modalMsg").innerText = "‡§¶‡•ã‡§®‡•ç‡§π‡•Ä ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§Ü‡§π‡•á";
    return;
  }

  $("modalMsg").innerText = "Checking...";

  const r = await fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"recoverPin",
      mobile,
      reg
    })
  });

  const out = await r.json();

  if(out.status === "SUCCESS"){
    $("modalMsg").innerHTML = `‚úÖ ‡§§‡•Å‡§Æ‡§ö‡§æ PIN: <b>${out.pin}</b>`;
  }
  else if(out.status === "WRONG"){
    $("modalMsg").innerText =
      `‚ùå ‡§ö‡•Å‡§ï‡•Ä‡§ö‡•Ä ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä. Attempts left: ${out.attemptsLeft}`;
  }
  else if(out.status === "BLOCKED"){
    $("modalMsg").innerText =
      `üö´ 60 ‡§Æ‡§ø‡§®‡§ø‡§ü block. ${out.minutesLeft} ‡§Æ‡§ø‡§®‡§ø‡§ü‡§æ‡§Ç‡§®‡•Ä ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ`;
  }
  else{
    $("modalMsg").innerText = "User ‡§∏‡§æ‡§™‡§°‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä";
  }
}



/* ================= TAB SWITCHING ================= */
function switchTab(tabId) {
  const containers = ['home', 'available', 'sold', 'completed', 'market'];
  containers.forEach(id => {
    const el = document.getElementById(id);
    if(el) el.style.display = 'none';
  });
  const target = document.getElementById(tabId);
  if (target) {
    if (tabId === 'home') {
      target.style.display = 'block';
    } else if (tabId === 'market') {
      target.style.display = 'block'; 
      if (!marketInited) { initMarketUI(); marketInited = true; }
    } else {
      target.style.display = 'grid';
    }
  }
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  const activeTab = document.querySelector(`.tab[data-tab="${tabId}"]`);
  if(activeTab) activeTab.classList.add('active');

  if (tabId === 'available') loadAvailable();
  if (tabId === 'sold') loadSold();
  if (tabId === 'completed') loadCompleted();
}

/* ================= AVAILABLE CROPS ================= */
async function loadAvailable(){
  try {
    const u = window.mspUser;
    const r = await fetch(`${API}?action=getAvailableCrops&mobile=${u.mobile}&userType=${u.type}`);
    const rows = await r.json();
    const sorted = sortByTimeAvailable(rows);
    $("available").innerHTML = sorted.map(r => cardHTML({
      csn: r.csn, produce: r.produce, variety: r.variety, sellerName: r.sellerName,
      packingType: r.sellerPackType, packingNos: r.sellerPackNos, weight: r.weight,
      photo: r.photo, isCompleted: false, buyerName: r.buyerName
    })).join("");
  } catch(e) { console.error(e); }
}

function cardHTML(r){
  const isBuyer = window.isBuyer || false;
  return `
  <div class="crop-card">
    <div class="crop-card-inner">
      <div class="crop-left">
        ${r.isCompleted ? `<div class="paid-badge">PAID</div>` : ""}
        <div class="line"><b>CSN No: ${r.csn}</b></div>
        <div class="line">${r.produce} (${r.variety})</div>
        <div class="line">${r.weight} kg (${r.packingNos} ${r.packingType})</div>
        <div class="line">Farmer: ${r.sellerName}</div>
        <button class="btn secondary" onclick="shareAvailableText('${encodeURIComponent(JSON.stringify(r))}')">Share</button>
        ${(isBuyer && !r.buyerName && !r.isCompleted)
          ? `<button class="btn secondary" onclick="expandBuyerForm('${r.csn}')">Buy Now</button>` : ""}
      </div>
      <img class="crop-photo" src="${r.photo || 'https://placehold.co/150'}" onerror="this.src='https://placehold.co/150'">
    </div>
    <div id="mini-${r.csn}" style="display:none"></div>
  </div>`;
}
  
  
/* ================= Buyer Requirements ================= */
  
  async function loadBuyerRequirementCards(){
  const res = await fetch(API+"?action=getBuyerRequirements");
  const rows = await res.json();

  $("buyerReqScroll").innerHTML = rows
    .filter(r => r.status === "Open")
    .map(r => `
      <div class="crop-card" style="min-width:260px;">
        <div class="line"><b>${r.crop} ${r.variety || ""}</b></div>
        <div class="line">Qty: ${r.quantity} Kg</div>
        <div class="line">Location: ${r.location}</div>
        <div class="line">Delivery: ${formatDateTime(r.deliveryDate)}</div>

        <div style="display:flex;gap:8px;margin-top:8px;">
          <button class="btn secondary"
            onclick="shareBuyerRequirement('${encodeURIComponent(JSON.stringify(r))}')">
            Share
          </button>

          ${window.isSeller ? `
            <button class="btn secondary"
              onclick="openBookRequirement('${encodeURIComponent(JSON.stringify(r))}')">
              Book Now
            </button>` : ``}
        </div>
      </div>
    `).join("");
}

  
  async function submitBuyerRequirement(){
  const u = window.mspUser;
  if(!u){
    alert("Login required");
    return;
  }

  $("br_msg").innerText = "Saving...";

  await fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action: "addBuyerRequirement",
      buyerMobile: u.mobile,
      buyerName: u.name,
      buyerType: u.type,
      crop: $("br_crop").value,
      variety: $("br_variety").value,
      quantity: $("br_qty").value,
      expectedRate: $("br_rate").value,
      location: $("br_location").value,
      deliveryDate: $("br_date").value,
      frequency: $("br_freq").value
    })
  });

  $("br_msg").innerText = "‚úÖ Requirement Posted";

  // reset form
  $("br_crop").value = "";
  $("br_variety").value = "";
  $("br_qty").value = "";
  $("br_rate").value = "";
  $("br_location").value = "";
  $("br_date").value = "";
  $("br_freq").value = "One-time";

  loadBuyerRequirementCards();
}


  
  function openBookRequirement(encoded){
  const r = JSON.parse(decodeURIComponent(encoded));

  const csnList = document.querySelectorAll("#available .crop-card");
  let options = "";

  csnList.forEach(c=>{
    const csn = c.querySelector(".line b")?.innerText;
    if(csn) options += `<option>${csn.replace("CSN No:","").trim()}</option>`;
  });

  const box = document.createElement("div");
  box.className = "modal-backdrop";
  box.innerHTML = `
    <div class="modal-box">
      <h3>${r.crop} Requirement</h3>
      <label>Select CSN</label>
      <select id="reqCSN">${options}</select>

      <div class="modal-actions">
        <button class="btn secondary" onclick="this.closest('.modal-backdrop').remove()">Cancel</button>
        <button class="btn" onclick="confirmRequirement('${r.timestamp}')">Confirm</button>
      </div>
    </div>`;
  document.body.appendChild(box);
}

  
  async function confirmRequirement(ts){
  const csn = $("reqCSN").value;

  await fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"matchRequirement",
      timestamp: ts,
      csn: csn
    })
  });

  alert("Requirement booked. Coordinator will follow up.");
  document.querySelector(".modal-backdrop")?.remove();
  loadBuyerRequirementCards();
}

  
  function openConnectCSN(req){
  const r = JSON.parse(decodeURIComponent(req));

  const box = document.createElement("div");
  box.className = "modal-backdrop";
  box.innerHTML = `
    <div class="modal-box">
      <h3>${r.crop} Requirement</h3>

      <label>Select CSN</label>
      <input id="reqCSN" placeholder="Enter CSN e.g. 20260124-001">

      <div class="modal-actions">
        <button class="btn secondary"
          onclick="this.closest('.modal-backdrop').remove()">
          Cancel
        </button>
        <button class="btn"
          onclick="confirmCSN('${r.timestamp}')">
          Connect CSN
        </button>
      </div>
    </div>`;
  document.body.appendChild(box);
}
  

  async function confirmCSN(timestamp){
  const csn = $("reqCSN").value;
  if(!csn){ alert("CSN required"); return; }

  await fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"matchRequirement",
      timestamp: timestamp,
      csn: csn
    })
  });

  alert("CSN connected. Coordinator will follow up.");
  document.querySelector(".modal-backdrop").remove();
  loadBuyerRequirementCards();
}

  
  function formatDateTime(dt){
  if(!dt) return "";
  const d = new Date(dt);

  return d.toLocaleString("en-IN", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
    hour12: true
  });
}

  function shareBuyerRequirement(encoded){
  const r = JSON.parse(decodeURIComponent(encoded));

  const text =
`Buyer Requirement üßæ

Crop: ${r.crop} ${r.variety || ""}
Quantity: ${r.quantity} Kg
Location: ${r.location}
Delivery: ${formatDateTime(r.deliveryDate)}

Login to mandi.mazisheti.org to book`;

  if(navigator.share){
    navigator.share({ text });
  } else {
    window.open(
      "https://wa.me/?text=" + encodeURIComponent(text),
      "_blank"
    );
  }
}

function openBuyerReqForm(){
  // ‡§´‡§ï‡•ç‡§§ Buyer ‡§∏‡§æ‡§†‡•Ä
  if(window.mspUser.type !== "Buyer"){
    alert("Buyer only");
    return;
  }

  $("buyerReqForm").style.display = "block";
  $("buyerReqForm").scrollIntoView({ behavior: "smooth" });
}

/* ================= SOLD / PENDING ================= */
async function loadSold(){
  try {
    const u = window.mspUser;
    const res = await fetch(`${API}?action=getLedger&mobile=${u.mobile}&userType=${u.type}`);
    const rows = await res.json();

    const sorted = sortByTime(rows);

    const list = sorted
      .filter(r => r[13] && !r[31]) // buyer exists, payment not done
      .map(r => ({
        csn: r[1],
        produce: r[6],
        variety: r[7],
        weight: r[21],
        packingNos: r[20],
        packingType: r[19],
        buyerName: r[16],
        netPayable: r[30]
      }));

    $("sold").innerHTML = list.map(r => `
      <div class="crop-card">
        <div class="crop-left">
          <div class="line"><b>CSN: ${r.csn}</b></div>
          <div class="line">${r.produce} (${r.variety})</div>
          <div class="line">${r.weight} kg (${r.packingNos} ${r.packingType})</div>
          <div class="line">Buyer: ${r.buyerName}</div>
          <div class="net-pill">Net Payable: ‚Çπ${r.netPayable}</div>

          ${
            window.isCoordinator
              ? `<button class="btn secondary"
                    onclick="openPaymentForm('${r.csn}', ${r.netPayable})">
                    Finalize Payment
                 </button>`
              : ""
          }
        </div>

        <div id="pay-${r.csn}" style="display:none"></div>
      </div>
    `).join("");

  } catch(e) {
    console.error(e);
  }
}

  
  

/* ================= COMPLETED ================= */
async function loadCompleted() {
  try {
    const res = await fetch(API + "?action=getLedger");
    const rows = await res.json();
    const sorted = sortByTime(rows);
    const list = sorted.filter(r => r[31])
      .map(r => ({
        csn: r[1], sellerName: r[2], buyerName: r[16], produce: r[6], variety: r[7],
        weight: r[21], packingNos: r[20], packingType: r[9], transport: Number(r[24]||0),
        porter: Number(r[23]||0), weighing: Number(r[25]||0), other: Number(r[26]||0),
        rate: Number(r[27]||0), patti: Number(r[28]||0), buyerTimestamp: r[13],
        expenses: Number(r[29]||0), netPayable: Number(r[30]||0), photo: r[12]
      }));

    $("completed").innerHTML = list.map(r => {
      const safeData = encodeURIComponent(JSON.stringify(r));
      return `
      <div class="crop-card">
        <div class="crop-card-inner">
          <div class="crop-left">
            <div class="line"><b>CSN: ${r.csn}</b></div>
            <div class="line">${r.produce} (${r.variety})</div>
            <div class="line">${r.weight} Kg (${r.packingNos} ${r.packingType})</div>
            <div class="line">Seller: ${r.sellerName}</div>
            <div class="line">Buyer: ${r.buyerName}</div>
            <div class="action-row">
              <div class="net-pill"> ‚Çπ${r.netPayable}</div>
              <button class="btn secondary" onclick="handleShare('${safeData}')">Share</button>
            </div>
            </div>
          <img class="crop-photo" src="${r.photo || 'https://placehold.co/150'}" onerror="this.src='https://placehold.co/150'">
        </div>
      </div>`;
    }).join("");
  } catch(e) { console.error(e); }
}
  
function handleShare(encodedData) {
    const r = JSON.parse(decodeURIComponent(encodedData));
    shareBillImage(r);
}

/* ================= TRANSACTIONS (Buyer/Payment) ================= */
function expandBuyerForm(csn){
  document.querySelectorAll("[id^='mini-']").forEach(x => x.style.display="none");
  const box = $("mini-"+csn);
  box.style.display = "block";
  box.innerHTML = `
  <div class="buyer-mini">
    <div class="grid">
  <div><label>Packing Nos</label><input id="bpack-${csn}" type="number"></div>
  <div><label>Weight (Kg)</label><input id="bwt-${csn}" type="number"> </div>
</div>
    <div class="grid">
      <div><label>Rate</label><input id="brate-${csn}" type="number" value="0"></div>
      <div><label>Commission</label><input id="bcom-${csn}" type="number" value="0"></div>
    </div>
    <div class="grid">
      <div><label>Porter</label><input id="bpor-${csn}" type="number" value="0"></div>
      <div><label>Transport</label><input id="btra-${csn}" type="number" value="0"></div>
    </div>
    <div class="grid">
      <div><label>Weighing</label><input id="bwei-${csn}" type="number" value="0"></div>
      <div><label>Other</label><input id="both-${csn}" type="number" value="0"></div>
    </div>
    <button class="btn" onclick="saveBuyer('${csn}')">Save Buyer Entry</button>
  </div>`;
}

async function saveBuyer(csn){
  const u = window.mspUser;

  const payload = {
    action: "addBuyer",
    csn,

    // ‚úÖ login user ‚Üí buyer
    buyerMobile: u.mobile,
    buyerReg: u.reg,
    buyerName: u.name,
    buyerAddress: u.address,
    buyerType: "Buyer",

    // transaction
    packNos: $(`bpack-${csn}`).value,
    weight:  $(`bwt-${csn}`).value,
    commission: $(`bcom-${csn}`).value,
    porter: $(`bpor-${csn}`).value,
    transport: $(`btra-${csn}`).value,
    weighing: $(`bwei-${csn}`).value,
    other: $(`both-${csn}`).value,
    rate: $(`brate-${csn}`).value
  };

  await fetch(API, { method:"POST", body: JSON.stringify(payload) });
  loadAllTabs();
}

function openPaymentForm(csn, amount){
  const box = $("pay-"+csn);
  box.style.display="block";
  box.innerHTML=`
  <div class="buyer-mini">
    <label>Amount Paid</label><input id="paid-${csn}" type="number" value="${amount}">
    <label>Mode</label>
    <select id="mode-${csn}"><option>Cash</option><option>Online</option><option>Bank Transfer</option><option>UPI</option></select>
    <label>Transaction ID</label><input id="tx-${csn}" type="text">
    <button class="btn" onclick="savePayment('${csn}')">Save Payment</button>
  </div>`;
}

async function savePayment(csn){
  const payload = { action: "addPayment", csn, paid: $(`paid-${csn}`).value, mode: $(`mode-${csn}`).value, txid: $(`tx-${csn}`).value };
  await fetch(API, {method:"POST", body:JSON.stringify(payload)});
  loadAllTabs();
}

async function submitSeller(){
  const u = window.mspUser;

  const btn = document.querySelector("#sellerForm .btn");
  btn.disabled = true;

  $("sellerMsg").innerText = "Saving...";

  const payload = {
    action: "addSeller",
    sellerName: u.name,
    contact: u.mobile,
    regNo: u.reg,
    sellerType: u.type,
    produce: $("s_crop").value,
    variety: $("s_variety").value,
    harvestDate: $("s_harv").value,
    sellerPackType: $("s_packType").value,
    sellerPackNos: $("s_packNos").value,
    weight: $("s_weight").value,
    sellerPhoto: $("s_photo").value
  };

  try {
    const r = await fetch(API, {
      method: "POST",
      body: JSON.stringify(payload)
    });

    const t = await r.json();

    if(t.status === "SUCCESS" && t.csn){
      $("sellerMsg").innerText = "";

      // üî• SHOW CSN POPUP
      showCSNModal(t.csn);

      // refresh lists
      loadAllTabs();
    } else {
      $("sellerMsg").innerText = "Error while saving. Try again.";
      btn.disabled = false;
    }

  } catch (e) {
    $("sellerMsg").innerText = "Network error. Please retry.";
    btn.disabled = false;
  }
}


function scrollToSeller(){
  $("sellerForm").style.display="block";
  $("sellerForm").scrollIntoView({behavior:"smooth"});
}

function shareAvailableText(encodedData){
  const r = JSON.parse(decodeURIComponent(encodedData));
  const text = `Available Crop üöö\n\nCSN: ${r.csn}\nCrop: ${r.produce} (${r.variety})\nQuantity: ${r.weight} Kg\nPacking: ${r.packingNos} ${r.packingType}\nFarmer: ${r.sellerName}\n\nüìû Login to mandi.mazisheti.org check more details `;
  if(navigator.share){ navigator.share({ text }); }
  else { window.open("https://wa.me/?text=" + encodeURIComponent(text), "_blank"); }
}

/* ================= BILL IMAGE GENERATION ================= */
async function shareBillImage(r) {
  const options = { day: '2-digit', month: 'short', year: '2-digit' };
  const billDate = r.buyerTimestamp ? new Date(r.buyerTimestamp).toLocaleDateString("mr-IN", options) : new Date().toLocaleDateString("mr-IN", options);
  const html = `
<div id="bill-container" style="width: 100%; max-width: 400px; background: #ffffff; padding: 15px; font-family: 'Arial', sans-serif; color: #000; box-sizing: border-box;">
      <div style="text-align: center; margin-bottom: 12px; line-height: 1.1;">
        <div style="font-size: 13px; font-weight: normal; margin-bottom: 2px;">‡§Æ‡§æ‡§ù‡•Ä‡§∂‡•á‡§§‡•Ä ‡§∂‡•á‡§§‡§ï‡§∞‡•Ä ‡§™‡•ç‡§∞‡§§‡§ø‡§∑‡•ç‡§†‡§æ‡§® ‡§™‡•Å‡§∞‡§∏‡•ç‡§ï‡•É‡§§</div>
        <h1 style="font-size: 24px; font-weight: 900; margin: 0; text-transform: uppercase;">${r.collectionCenter || "MSP Trading CO."}</h1>
        <h2 style="font-size: 14px; font-weight: bold; margin: 2px 0 0 0;">üåê mandi.mazisheti.org ${r.regNo || "üìû 9975740444"}</h2>
      </div>
      <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px; font-weight: bold; border-top: 2px solid #000; padding-top: 5px;">
        <span>CSN: ${r.csn}</span><span>‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï: ${billDate}</span>
      </div>
      <hr style="border: 0; border-top: 1px solid #eee; margin: 5px 0 12px 0;">
      <div style="font-size: 15px; line-height: 1.5; margin-bottom: 15px;">
        <div style="display: flex; margin-bottom: 3px;"><span style="min-width: 85px; color: #555;"><b>‡§∂‡•á‡§§‡§ï‡§∞‡•Ä:</b></span><span style="font-weight: bold;">${r.sellerName}</span></div>
        <div style="display: flex;"><span style="min-width: 85px; color: #555;"><b>‡§ñ‡§∞‡•á‡§¶‡•Ä‡§¶‡§æ‡§∞:</b></span><span style="font-weight: bold;">${r.buyerName || '-'}</span></div>
      </div>
      <div style="font-size: 15px; line-height: 1.6; margin-bottom: 8px; border: 1px solid #e0e0e0; padding: 12px; border-radius: 8px; background-color: #ffffff;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span style="color: #555;">‡§Æ‡§æ‡§≤‡§æ‡§ö‡•á ‡§®‡§æ‡§µ:</span><span style="font-weight: 700;">${r.produce} ${r.variety ? `(${r.variety})` : ''}</span></div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 2px;"><span style="color: #555;">‡§™‡•Ö‡§ï‡§ø‡§Ç‡§ó:</span><span style="font-weight: 600;">${r.packingNos} ${r.packingType}</span></div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 2px;"><span style="color: #555;">‡§µ‡§ú‡§®:</span><span style="font-weight: 600;">${r.weight} Kg</span></div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 2px;"><span style="color: #555;">‡§¶‡§∞ (10Kg):</span><span style="font-weight: 600;">‚Çπ${r.rate}</span></div>
        <div style="border-top: 1px dashed #ddd; margin: 8px 0;"></div>
        <div style="display: flex; justify-content: space-between; align-items: center;"><span style="font-weight: 800; font-size: 16px;">‡§™‡§ü‡•ç‡§ü‡•Ä:</span><span style="font-weight: 900; font-size: 20px;">‚Çπ${r.patti}</span></div>
      </div>
      <div style="background: #fcfcfc; padding: 12px; border-radius: 8px; font-size: 14px; border: 1px solid #e0e0e0;">
        <div style="font-weight: 800; color: #666; font-size: 12px; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 2px;">‡§ñ‡§∞‡•ç‡§ö ‡§§‡§™‡§∂‡•Ä‡§≤</div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;"><span>‡§ó‡§æ‡§°‡•Ä ‡§≠‡§æ‡§°‡•á:</span> <span>‚Çπ${r.transport}</span></div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;"><span>‡§π‡§Æ‡§æ‡§≤‡•Ä:</span> <span>‚Çπ${r.porter}</span></div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;"><span>‡§§‡•ã‡§≤‡§æ‡§à:</span> <span>‚Çπ${r.weighing}</span></div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;"><span>‡§ü‡§™‡§æ‡§≤ ‡§µ ‡§á‡§§‡§∞:</span> <span>‚Çπ${r.other}</span></div>
        <div style="border-top: 1px solid #ddd; margin: 8px 0;"></div>
        <div style="display: flex; justify-content: space-between; font-weight: 700; color: #d32f2f;"><span>‡§è‡§ï‡•Ç‡§£ ‡§ñ‡§∞‡•ç‡§ö:</span> <span>- ‚Çπ${r.expenses}</span></div>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0; padding: 12px; border: 2px dashed #16a34a; border-radius: 8px; background: #f0fff4;">
        <div style="text-align: left;"><span style="font-size: 12px; color: #555; display: block; font-weight: bold;">‡§®‡§ø‡§µ‡•ç‡§µ‡§≥ ‡§¶‡•á‡§Ø ‡§∞‡§ï‡•ç‡§ï‡§Æ</span><span style="font-size: 24px; font-weight: 900; color: #16a34a;">‚Çπ ${r.netPayable}</span></div>
        <div style="text-align: right; border-left: 1px solid #c3e6cb; padding-left: 15px;"><span style="font-size: 12px; color: #555; display: block; font-weight: bold;">‡§∂‡•á‡§§‡§ï‡§∞‡•Ä ‡§¶‡§∞</span><span style="font-size: 18px; font-weight: 800; color: #16a34a;">‚Çπ ${Math.ceil(r.netPayable / r.weight)} /‡§ï‡§ø‡§≤‡•ã</span></div>
      </div>
      <div style="display: flex; justify-content: space-between; margin-top: 30px; font-size: 13px; text-align: center;">
        <div style="width: 42%; border-top: 1px solid #000; padding-top: 5px;"><b>‡§∂‡•á‡§§‡§ï‡§∞‡•Ä ‡§∏‡•ç‡§µ‡§æ‡§ï‡•ç‡§∑‡§∞‡•Ä</b></div>
        <div style="width: 42%; border-top: 1px solid #000; padding-top: 5px;"><b>‡§Ö‡§ß‡§ø‡§ï‡•É‡§§ ‡§∏‡•ç‡§µ‡§æ‡§ï‡•ç‡§∑‡§∞‡•Ä</b></div>
      </div>
      <div style="text-align: center; font-size: 11px; color: #888; margin-top: 15px;">Thanks.<br><span style="font-size: 9px;">This is system generated bill, for detailed transaction visit https://mandi.mazisheti.org.</span></div>
    </div>`;

  document.getElementById("billImageBox").innerHTML = html;
  try {
    const canvas = await html2canvas(document.getElementById("bill-container"), { scale: 3, backgroundColor: "#ffffff", useCORS: true });
    canvas.toBlob(async (blob) => {
      const file = new File([blob], `Bill-${r.csn}.jpg`, { type: "image/jpeg" });
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({ files: [file], title: "Mandi Bill", text: `‡§™‡§æ‡§µ‡§§‡•Ä ‡§ï‡•ç‡§∞: ${r.csn}` });
      } else {
        const a = document.createElement("a"); a.href = canvas.toDataURL("image/jpeg", 1.0); a.download = `Bill-${r.csn}.jpg`; a.click();
      }
    }, "image/jpeg", 1.0);
  } catch (err) { console.error("Error creating bill image:", err); }
}
  
/* ================= Dashboard ================= */
function switchTab(name){
  const tabs = ["home","available","sold","completed","market"];

  tabs.forEach(t=>{
    const el = document.getElementById(t);
    if(!el) return;

    // üî• display rules
    if(t === "home"){
      el.style.display = (t === name) ? "block" : "none";
    }
    else if(t === "market"){
      el.style.display = (t === name) ? "block" : "none";
    }
    else {
      // available / sold / completed
      el.style.display = (t === name) ? "grid" : "none";
    }

    const tabBtn = document.querySelector(`[data-tab="${t}"]`);
    if(tabBtn){
      tabBtn.classList.toggle("active", t === name);
    }
  });

  // lazy init market
  if(name === "market"){
    if(!window.marketInited){
      initMarketUI();
      window.marketInited = true;
    }
  }
}

function openDashboard(user){

  /* ===== Move ticker to dashboard ===== */
  const tickerWrap = document.getElementById("globalTicker");
  const slot = document.getElementById("dashboardTickerSlot");
  if(slot && tickerWrap){
    slot.appendChild(tickerWrap);
    tickerWrap.style.display = "block";
  }

  document.body.classList.remove("login-mode");

  $("loginScreen").style.display = "none";
  $("dashboard").style.display = "block";

  /* ===== USER CONTEXT (üî• VERY IMPORTANT) ===== */
  window.mspUser        = user;
window.isFarmer = (user.type === "Collection Center" || user.type === "Farmer"); window.isCoordinator = (user.type === "Coordinator"); window.isBuyer = (user.type === "Buyer"); window.isSeller = window.isFarmer || window.isCoordinator;
  $("userInfo").innerText = `${user.name} (${user.type})`;

  /* ===== FAB LOGIC ===== */
  const fab = document.querySelector(".fab-add");
  if(fab){
    // Farmer ‚Üí Add Crop
    // Buyer ‚Üí Add Requirement
    // Coordinator ‚Üí allowed (if needed later)
    fab.style.display =
      (window.isFarmer || window.isBuyer || window.isCoordinator)
        ? "flex" : "none";
  }

  /* ===== Reset ticker state ===== */
  const ticker = document.querySelector(".ticker");
  if(ticker) ticker.classList.remove("paused");

  initTickerTouch();
  initTickerLinks();

  /* ===== Load dashboard ===== */
  switchTab("home");

  loadAvailable();
  loadSold();
  loadCompleted();
  loadBuyerRequirementCards();

  if(window.isFarmer){
    loadFarmerHome();
  } else {
    const fs = document.getElementById("farmerSummary");
    if(fs) fs.style.display = "none";
  }
}



let CROP_MAP=null;
async function loadCropMap(){
  if(CROP_MAP) return CROP_MAP;
  const r = await fetch(API+"?action=getCropMap");
  CROP_MAP = await r.json();
  return CROP_MAP;
}

function normalizeCrop(n){
  if(!n) return "";
  const k=n.toLowerCase().replace(/\(.*?\)/g,"").trim();
  return (CROP_MAP && CROP_MAP[k]) ? CROP_MAP[k] : n.trim();
}

/* ================= NEW BEAUTIFUL SUMMARY LOGIC ================= */
async function loadFarmerHome(){
  await loadCropMap();
  const u = window.mspUser;
  const r = await fetch(`${API}?action=getLedger&mobile=${u.mobile}&userType=${u.type}`);
  const rows = await r.json();

  let qtyTotal = 0, netTotal = 0;
  const stats = {};

rows.forEach(r => {
  if(!r || !r[6]) return;

  const crop = normalizeCrop(r[6]);
  const qty = Number(r[21] || 0);
  const rate10 = Number(r[27] || 0);
  if(!crop || !qty || !rate10) return;


    const rateKg = rate10 / 10;
    // ‡§Æ‡§π‡§ø‡§®‡•ç‡§Ø‡§æ‡§ö‡•á ‡§≤‡•â‡§ú‡§ø‡§ï (Month Detection)
    const mDate = new Date(r[13] || r[0]);
    const monthName = mDate.toLocaleString("mr-IN", { month: "short" }); // ‡§â‡§¶‡§æ. ‡§ú‡•Ç‡§®, ‡§ú‡•Å‡§≤‡•à

    if(!stats[crop]){ 
      stats[crop] = { qty: 0, sum: 0, cnt: 0, max: rateKg, maxM: monthName, min: rateKg, minM: monthName }; 
    }
    
    const c = stats[crop];
    c.qty += qty; 
    c.sum += rateKg; 
    c.cnt++;

    // Highest Rate Logic
    if(rateKg >= c.max){
      c.max = rateKg;
      c.maxM = monthName;
    }
    // Lowest Rate Logic
    if(rateKg <= c.min){
      c.min = rateKg;
      c.minM = monthName;
    }

    qtyTotal += qty;
    netTotal += Number(r[30] || 0);
  });

  $("kpiCSN").innerText = rows.length;
  $("kpiCrops").innerText = Object.keys(stats).length;
  $("kpiQty").innerText = qtyTotal;
  $("kpiNet").innerText = "Rs. " + netTotal;

  let html = "";
  Object.entries(stats)
    .sort((a,b) => b[1].qty - a[1].qty)
    .forEach(([c, v]) => {
      const avg = Math.round(v.sum / v.cnt);
      html += `
      <div class="summary-card">
        <div class="sum-header">
          <div class="sum-name">${c}</div>
          <div class="sum-badge">${v.qty} Kg ‡§è‡§ï‡•Ç‡§£</div>
        </div>
        <div class="sum-stats">
            <div class="stat-box">
               <div class="stat-lbl">‡§∏‡§∞‡§æ‡§∏‡§∞‡•Ä</div>
               <div class="stat-val">‚Çπ${avg}</div>
               <div class="stat-month">Avg/Kg</div>
            </div>
            <div class="stat-box">
               <div class="stat-lbl">‡§â‡§§‡•ç‡§§‡§Æ ‡§¶‡§∞</div>
               <div class="stat-val" style="color:#16a34a">‚Çπ${v.max}</div>
               <div class="stat-month">${v.maxM} ‡§Æ‡§ß‡•ç‡§Ø‡•á</div>
            </div>
            <div class="stat-box">
               <div class="stat-lbl">‡§ï‡§Æ‡•Ä ‡§¶‡§∞</div>
               <div class="stat-val" style="color:#dc2626">‚Çπ${v.min}</div>
               <div class="stat-month">${v.minM} ‡§Æ‡§ß‡•ç‡§Ø‡•á</div>
            </div>
        </div>
      </div>`;
    });
  $("cropWise").innerHTML = html;
}
  
function monthKey(d){ return new Date(d).toLocaleString("en-IN", { month: "short", year: "numeric" }); }

function toDate(v){ return (v instanceof Date) ? v : new Date(v); }
function weekNo(d){
  d = new Date(d); d.setHours(0,0,0,0);
  d.setDate(d.getDate() + 4 - (d.getDay()||7));
  const y = new Date(d.getFullYear(),0,1);
  return Math.ceil((((d-y)/86400000)+1)/7);
}

function sortByTimeAvailable(rows){ return rows.sort((a,b) => new Date(b.harvestDate || 0) - new Date(a.harvestDate || 0)); }
function sortByTime(rows){
  const now = new Date();
  const curWeek = weekNo(now);
  const curMonth = now.getMonth();
  const curYear = now.getFullYear();
  return rows.sort((a,b) => {
    const da = toDate(a[0]); const db = toDate(b[0]);
    const wa = weekNo(da), wb = weekNo(db);
    if(wa===curWeek && wb!==curWeek) return -1;
    if(wb===curWeek && wa!==curWeek) return 1;
    if(wa===curWeek-1 && wb!==curWeek-1) return -1;
    if(wb===curWeek-1 && wa!==curWeek-1) return 1;
    if(da.getMonth()===curMonth && da.getFullYear()===curYear && (db.getMonth()!==curMonth || db.getFullYear()!==curYear)) return -1;
    return db - da;
  });
}
  
/* ================= MARKET ================= */
let marketInited = false;
function loadMarketData(){
  const dateInput = document.getElementById("marketDate");
  const mandiSelect = document.getElementById("mandiSelect");
  const typeSelect = document.getElementById("typeSelect");
  const marketFrame = document.getElementById("marketFrame");
  const marketResult = document.getElementById("marketResult");
  const date  = dateInput.value;
  const mandi = mandiSelect.value;
  const type  = typeSelect.value;
  if(mandi !== "mumbai"){
    marketFrame.src = "";
    marketResult.innerText = "‚ö†Ô∏è ‡§π‡§æ ‡§Æ‡§Ç‡§°‡•Ä ‡§°‡•á‡§ü‡§æ ‡§∏‡§ß‡•ç‡§Ø‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä";
    return;
  }
  marketResult.innerText = "";
  marketFrame.src = `https://apmcmumbai.org/bajarbhav/view-daily-bajarbhav/${type}/${date}`;
}

function formatShortDate(d){ return d.toLocaleDateString("en-GB",{ day:"2-digit", month:"short" }); }
function initMarketUI(){
  const dateInput = document.getElementById("marketDate");
  const dateLabel = document.getElementById("dateLabel");
  const mandiSelect = document.getElementById("mandiSelect");
  const typeSelect = document.getElementById("typeSelect");
  const d = new Date();
  dateInput.value = d.toISOString().split("T")[0];
  dateLabel.innerText = formatShortDate(d);
  dateLabel.onclick = ()=> dateInput.showPicker();
  dateInput.onchange = ()=>{ dateLabel.innerText = formatShortDate(new Date(dateInput.value)); loadMarketData(); };
  mandiSelect.onchange = loadMarketData;
  typeSelect.onchange  = loadMarketData;
  loadMarketData();
}
  
  function initTickerLinks(){
  document.querySelectorAll(".ticker a").forEach(a=>{
    a.addEventListener("touchstart", e=>{
      e.stopPropagation();   // pause logic block
    });
    a.addEventListener("click", e=>{
      e.stopPropagation();
    });
  });
}

  function initTickerTouch(){
  const wrap = document.querySelector(".ticker-wrap");
  const ticker = document.querySelector(".ticker");
  if(!wrap || !ticker) return;

  let paused = false;

  wrap.addEventListener("touchstart", e=>{
    if(e.target.closest("a")) return; // link tap ignore

    paused = !paused;
    ticker.classList.toggle("paused", paused);
  });
}

  async function loadTicker(){
  const r = await fetch(API + "?action=getTicker");
  const rows = await r.json();

  if(!rows.length) return;

  const makeContent = () =>
    rows.map(x =>
      `<a href="${x.link}" target="_blank">${x.text}</a>`
    ).join(`<span class="sep"> | </span>`);

  // duplicate content for smooth scroll
  const html = `
    <span class="ticker-content">${makeContent()}</span>
    <span class="ticker-content">${makeContent()}</span>
  `;

  const t = document.getElementById("ticker");
  t.innerHTML = html;

  document.querySelector(".ticker-wrap").style.display = "block";
}

  
  function handleFabAction(){
  const u = window.mspUser;
  if(!u) return;

  // Farmer / Collection Center ‚Üí Add Crop
  if(["Farmer","Collection Center"].includes(u.type)){
    const f = document.getElementById("sellerForm");
    if(f){
      f.style.display = "block";
      f.scrollIntoView({ behavior:"smooth" });
    }
    return;
  }

  // Buyer ‚Üí Add Requirement
  if(u.type === "Buyer"){
    openBuyerReqForm();
  }
}
  
  
  function showCSNModal(csn){
  document.getElementById("csnValue").innerText = csn;
  document.getElementById("csnModal").style.display = "flex";
}

function closeCSNModal(){
  document.getElementById("csnModal").style.display = "none";
}


  
  
</script>
</body>
</html>
